name: List Repository Users

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  list-users:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - name: List Repository Collaborators
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -e  # Exit on error
          
          echo "=========================================="
          echo "Fetching all users (collaborators) for repository: $REPO_OWNER/$REPO_NAME"
          echo "=========================================="
          echo ""
          
          # Use GitHub CLI to call the REST API and store response
          if ! COLLABORATORS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/$REPO_OWNER/$REPO_NAME/collaborators" 2>&1); then
            echo "‚ùå Error: Failed to fetch collaborators from GitHub API"
            echo "$COLLABORATORS"
            exit 1
          fi
          
          echo "üìã Repository Collaborators:"
          echo "----------------------------"
          
          echo "$COLLABORATORS" | jq -r '.[] | "üë§ User: \(.login)\n   - ID: \(.id)\n   - Type: \(.type)\n   - Permissions: \(.permissions | to_entries | map("\(.key): \(.value)") | join(", "))\n   - URL: \(.html_url)\n"'
          
          echo ""
          echo "=========================================="
          echo "Total number of collaborators:"
          echo "$COLLABORATORS" | jq 'length'
          echo "=========================================="
